{% extends "admin/base.html" %}

{% block title %}View Submission - Admin{% endblock %}
{% block header %}Submission Details{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{{ url_for('admin.submissions') }}" class="text-gray-600 hover:text-gray-800">
        <i class="fas fa-arrow-left mr-2"></i>Back to Submissions
    </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Main Info -->
    <div class="lg:col-span-2 space-y-6">
        <!-- User Info -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-user mr-2 text-purple-600"></i>User Information
            </h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <p class="text-sm text-gray-500">Full Name</p>
                    <p class="font-medium text-gray-900">{{ analysis.user.full_name }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Email</p>
                    <p class="font-medium text-gray-900">{{ analysis.user.email }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Phone</p>
                    <p class="font-medium text-gray-900">{{ analysis.user.phone }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Submitted</p>
                    <p class="font-medium text-gray-900">{{ analysis.created_at.strftime('%B %d, %Y at %H:%M') }}</p>
                </div>
            </div>
        </div>
        
        <!-- Score Breakdown -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-chart-bar mr-2 text-purple-600"></i>Score Breakdown
            </h3>
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Experience (25%)</span>
                        <span class="text-sm font-medium text-gray-900">{{ analysis.experience_score|round(1) }}</span>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full">
                        <div class="h-full gradient-bg rounded-full" style="width: {{ analysis.experience_score }}%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Skills (25%)</span>
                        <span class="text-sm font-medium text-gray-900">{{ analysis.skills_score|round(1) }}</span>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full">
                        <div class="h-full bg-green-500 rounded-full" style="width: {{ analysis.skills_score }}%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Structure (20%)</span>
                        <span class="text-sm font-medium text-gray-900">{{ analysis.structure_score|round(1) }}</span>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full">
                        <div class="h-full bg-blue-500 rounded-full" style="width: {{ analysis.structure_score }}%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Career Alignment (15%)</span>
                        <span class="text-sm font-medium text-gray-900">{{ analysis.career_score|round(1) }}</span>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full">
                        <div class="h-full bg-yellow-500 rounded-full" style="width: {{ analysis.career_score }}%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Readability (15%)</span>
                        <span class="text-sm font-medium text-gray-900">{{ analysis.readability_score|round(1) }}</span>
                    </div>
                    <div class="h-2 bg-gray-200 rounded-full">
                        <div class="h-full bg-purple-500 rounded-full" style="width: {{ analysis.readability_score }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sections Detected -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-list mr-2 text-purple-600"></i>Sections Detected
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                {% for section_name, section_data in analysis.sections_detected.items() %}
                <div class="p-3 rounded-lg {{ 'bg-green-50 border border-green-200' if section_data.detected else 'bg-gray-50 border border-gray-200' }}">
                    <div class="flex items-center">
                        {% if section_data.detected %}
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        {% else %}
                            <i class="fas fa-times-circle text-gray-400 mr-2"></i>
                        {% endif %}
                        <span class="text-sm font-medium {{ 'text-green-700' if section_data.detected else 'text-gray-500' }}">
                            {{ section_name.replace('_', ' ').title() }}
                        </span>
                    </div>
                    {% if section_data.detected %}
                        <span class="text-xs text-green-600">Score: {{ section_data.quality_score|round(1) }}/10</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Skills Found -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-code mr-2 text-purple-600"></i>Skills Found ({{ analysis.skills_found|length if analysis.skills_found else 0 }})
            </h3>
            {% if analysis.skills_found %}
                <div class="flex flex-wrap gap-2">
                    {% for skill in analysis.skills_found %}
                        <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm">{{ skill }}</span>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-gray-500">No skills detected</p>
            {% endif %}
        </div>
        
        <!-- Extracted Text -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-file-alt mr-2 text-purple-600"></i>Extracted Text
            </h3>
            <div class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                <pre class="text-sm text-gray-700 whitespace-pre-wrap">{{ analysis.extracted_text[:5000] }}{% if analysis.extracted_text|length > 5000 %}...{% endif %}</pre>
            </div>
            <p class="text-sm text-gray-500 mt-2">Total: {{ analysis.text_length }} characters</p>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Score Card -->
        <div class="bg-white rounded-xl shadow-sm p-6 text-center">
            <div class="text-5xl font-bold {{ 'text-green-600' if analysis.score >= 80 else 'text-yellow-600' if analysis.score >= 60 else 'text-red-600' }} mb-2">
                {{ analysis.score|round(1) }}
            </div>
            <p class="text-gray-500">Overall Score</p>
        </div>
        
        <!-- Quick Info -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Info</h3>
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-500">Experience Level</p>
                    <p class="font-medium text-gray-900">{{ analysis.experience_level }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Career Field</p>
                    <p class="font-medium text-gray-900">{{ analysis.career_field }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Processing Time</p>
                    <p class="font-medium text-gray-900">{{ analysis.processing_time }}s</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Original File</p>
                    <p class="font-medium text-gray-900 break-all">{{ analysis.original_filename }}</p>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Actions</h3>
            <div class="space-y-3">
                <a href="{{ url_for('main.results', analysis_id=analysis.id) }}" 
                   target="_blank"
                   class="block w-full text-center px-4 py-2 gradient-bg text-white rounded-lg hover:opacity-90">
                    <i class="fas fa-external-link-alt mr-2"></i>View Public Results
                </a>
                <a href="{{ url_for('main.uploaded_file', filename=analysis.stored_filename) }}" 
                   target="_blank"
                   class="block w-full text-center px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                    <i class="fas fa-download mr-2"></i>Download CV
                </a>
                <form action="{{ url_for('admin.delete_submission', analysis_id=analysis.id) }}" 
                      method="POST"
                      onsubmit="return confirm('Are you sure you want to delete this submission?');">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" 
                            class="block w-full text-center px-4 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50">
                        <i class="fas fa-trash mr-2"></i>Delete Submission
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
